{% extends 'base.html' %}

{% block content %}
<h2>Responder Dashboard</h2>

<div class="responder-status">
    <h3>Your Status: {% if responder.is_available %}Available{% else %}On Call{% endif %}</h3>
    <p>Your emergency types:
        {% for type in responder.emergency_types.all %}
        {{ type.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    </p>
</div>

{% if assigned_alerts %}
<div class="assigned-alerts">
    <h3>Your Current Assignments</h3>
    {% for alert in assigned_alerts %}
    <div class="alert-card">
        <p>Emergency: {{ alert.emergency_type }}</p>
        <p>Status: {{ alert.get_status_display }}</p>
        <p>From: {{ alert.user.get_full_name }}</p>

        <div class="alert-actions">
            <a href="{% url 'emergency_chat' alert_id=alert.id %}" class="btn btn-chat">
                Open Chat
            </a>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="alert_id" value="{{ alert.id }}">
                <button type="submit" name="action" value="complete" class="btn btn-complete">
                    Mark Resolved
                </button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if available_alerts %}
<div class="available-alerts">
    <h3>Available Emergencies</h3>
    {% for alert in available_alerts %}
    <div class="alert-card">
        <p>Emergency: {{ alert.emergency_type }}</p>
        <p>Status: {{ alert.get_status_display }}</p>
        <p>From: {{ alert.user.get_full_name }}</p>

        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="alert_id" value="{{ alert.id }}">
            <button type="submit" name="action" value="accept" class="btn btn-accept">
                Accept Emergency
            </button>
        </form>
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
    // Update responder location periodically
    if (navigator.geolocation) {
        function updateLocation() {
            navigator.geolocation.getCurrentPosition(function (position) {
                fetch('{% url "update_location" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    })
                });
            });
        }

        // Update every 30 seconds
        setInterval(updateLocation, 30000);
        updateLocation(); // Initial call
    }
</script>
{% endblock %}